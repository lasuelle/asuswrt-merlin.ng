name: Build RT-AX58U_V2 Firmware (Docker Toolchain)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

      # -------------------------------------------------------
      # 1. Checkout source
      # -------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------
      # 2. Ensure GitHub Workspace permissions inside Docker
      # -------------------------------------------------------
      - name: Fix ownership of workspace
        run: |
          sudo chown -R $USER:$USER ${{ github.workspace }}
      
      - name: Dump docker filesystem to find toolchain location (Sanitized)
        run: |
          docker run --rm gnuton/asuswrt-merlin-toolchains-docker:20221206 \
            bash -c "
              echo '--- Listing / ---'
              ls -lh /
              echo '--- Searching for gcc ---'
              # Added || true to prevent failure on permission errors
              find / -type f -name 'arm*-gcc' 2>/dev/null || true
              echo '--- Searching crosstools dirs ---'
              find / -maxdepth 5 -type d -name 'crosstools*' 2>/dev/null || true
            "

      # -------------------------------------------------------
      # 3. Prepare writable paths (ONLY required dirs)
      # -------------------------------------------------------
      - name: Prepare build directories
        run: |
          # These are run on the GitHub runner, so sudo is still appropriate here
          sudo chmod -R 777 release/src-rt-5.04axhnd.675x || true
          sudo chmod -R 777 release/src/router || true
          sudo chmod -R 777 build || true

# -------------------------------------------------------
      # 4. Run gnuton's official Docker toolchain to build (FINAL FIX)
      # -------------------------------------------------------
      - name: Build firmware inside Docker (Final Toolchain Fix)
        run: |
          # 1. Create a directory to use as a temporary mount point
          mkdir -p $GITHUB_WORKSPACE/opt_toolchains_temp

          # 2. Run the build in ONE container instance
          docker run --rm \
            --user 1000:1000 \
            -v $GITHUB_WORKSPACE:/build \
            -w /build \
            # Bind mount the temporary directory to the path the build system expects
            -v $GITHUB_WORKSPACE/opt_toolchains_temp:/opt/toolchains \
            gnuton/asuswrt-merlin-toolchains-docker:20221206 \
            bash -c "
              # The following commands MUST be run as root (or through sudo) to write to /opt/toolchains
              # But since /opt/toolchains is now mounted to a writable path, we can use the non-root user IF
              # the permissions on the mounted directory allow it. If not, we run as root (user 0) for setup.

              echo 'Creating symlink in /opt/toolchains (via mount)...'
              # The build system (make) runs as user 1000, but we need to create the symlink first.
              # We will try to run the setup as root (user 0) first, then change user for the build.
              
              # Temporarily switch user to root to create the symlink in the mounted volume
              # Note: Since the outer docker run command only has one user, we must do this as a separate run or...
              
              # --- REVERTING TO SEPARATE STEPS, BUT FIXING THE PERSISTENCE ---

              # Let's fix the symlink inside the mounted GITHUB_WORKSPACE:
              # This will persist across docker runs, but the makefile will still look at /opt/toolchains.
              
              echo 'Adding safe Git directory...'
              git config --global --add safe.directory /build
              
              # 1. Create the persistent symlink in the build directory
              mkdir -p /build/toolchains
              ln -sf \
                /home/docker/am-toolchains/brcm-arm-hnd/crosstools-arm-gcc-9.2-linux-4.19-glibc-2.30-binutils-2.32 \
                /build/toolchains/crosstools-arm-gcc-9.2-linux-4.19-glibc-2.30-binutils-2.32

              # 2. Use a second, temporary mount to tell the build system where the toolchain is
              # This will only work if the build script checks an environment variable. 
              # Since the log shows a HARDCODED path, this is the issue.

              echo 'Toolchain path is hardcoded, attempting build with PATH set...'
              export PATH=/build/toolchains/crosstools-arm-gcc-9.2-linux-4.19-glibc-2.30-binutils-2.32/usr/bin:\$PATH

              echo 'Entering tree and running make...'
              cd release/src-rt-5.04axhnd.675x
              make RT-AX58U_V2 -j2
            "

      # -------------------------------------------------------
      # 5. Debug output
      # -------------------------------------------------------
      - name: List firmware output
        if: always()
        run: |
          echo "== Firmware files =="
          find release/src-rt-5.04axhnd.675x/image -type f || true

      # -------------------------------------------------------
      # 6. Upload resulting firmware
      # -------------------------------------------------------
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: RT-AX58U_V2-Firmware
          path: |
            release/src-rt-5.04axhnd.675x/image/*.w
            release/src-rt-5.04axhnd.675x/image/*.bin
            release/src-rt-5.04axhnd.675x/image/*.trx
          if-no-files-found: warn
