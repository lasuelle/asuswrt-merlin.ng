name: Build RT-AX58U_V2 Firmware (Docker Toolchain)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

      # -------------------------------------------------------
      # 1. Checkout source
      # -------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------
      # 2. Ensure GitHub Workspace permissions inside Docker
      # -------------------------------------------------------
      - name: Fix ownership of workspace
        run: |
          sudo chown -R $USER:$USER ${{ github.workspace }}
      
      - name: Dump docker filesystem to find toolchain location (Sanitized)
        run: |
          docker run --rm gnuton/asuswrt-merlin-toolchains-docker:20221206 \
            bash -c "
              echo '--- Listing / ---'
              ls -lh /
              echo '--- Searching for gcc ---'
              # Added || true to prevent failure on permission errors
              find / -type f -name 'arm*-gcc' 2>/dev/null || true
              echo '--- Searching crosstools dirs ---'
              find / -maxdepth 5 -type d -name 'crosstools*' 2>/dev/null || true
            "

      # -------------------------------------------------------
      # 3. Prepare writable paths (ONLY required dirs)
      # -------------------------------------------------------
      - name: Prepare build directories
        run: |
          # These are run on the GitHub runner, so sudo is still appropriate here
          sudo chmod -R 777 release/src-rt-5.04axhnd.675x || true
          sudo chmod -R 777 release/src/router || true
          sudo chmod -R 777 build || true

     # -------------------------------------------------------
      # 4a. Create the symlink in the EXPECTED location (/opt/toolchains)
      # -------------------------------------------------------
      - name: Create Toolchain Symlink in /opt (As Root)
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/build \
            -w /build \
            gnuton/asuswrt-merlin-toolchains-docker:20221206 \
            bash -c "
              echo 'Creating symlink in /opt/toolchains for make...'
              # These commands run as root (default user)
              mkdir -p /opt/toolchains
              ln -sf \
                /home/docker/am-toolchains/brcm-arm-hnd/crosstools-arm-gcc-9.2-linux-4.19-glibc-2.30-binutils-2.32 \
                /opt/toolchains/crosstools-arm-gcc-9.2-linux-4.19-glibc-2.30-binutils-2.32
            "

       # -------------------------------------------------------
      # 4b. Run gnuton's official Docker toolchain to build (As non-root)
      # -------------------------------------------------------
      - name: Run Build inside Docker (As 1000:1000)
        run: |
          docker run --rm \
            --user 1000:1000 \
            -v $GITHUB_WORKSPACE:/build \
            -w /build \
            gnuton/asuswrt-merlin-toolchains-docker:20221206 \
            bash -c "
              echo 'Adding safe Git directory...'
              git config --global --add safe.directory /build

              echo 'Export PATH so toolchain is found...'
              # PATH must now point to the symlink location: /opt/toolchains
              export PATH=/opt/toolchains/crosstools-arm-gcc-9.2-linux-4.19-glibc-2.30-binutils-2.32/usr/bin:\$PATH

              echo 'Entering tree and running make...'
              cd release/src-rt-5.04axhnd.675x
              make RT-AX58U_V2 -j2
            "     

      # -------------------------------------------------------
      # 5. Debug output
      # -------------------------------------------------------
      - name: List firmware output
        if: always()
        run: |
          echo "== Firmware files =="
          find release/src-rt-5.04axhnd.675x/image -type f || true

      # -------------------------------------------------------
      # 6. Upload resulting firmware
      # -------------------------------------------------------
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: RT-AX58U_V2-Firmware
          path: |
            release/src-rt-5.04axhnd.675x/image/*.w
            release/src-rt-5.04axhnd.675x/image/*.bin
            release/src-rt-5.04axhnd.675x/image/*.trx
          if-no-files-found: warn
